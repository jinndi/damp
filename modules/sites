#!/bin/bash

sitescontrol()
{
	clear
	mapfile -t sites < <(cd "$HOME/www/domains" && ls -d -- */ 2>/dev/null)
	declare -a cheksites=("+ $D_SITEADDNEW" "" "" "")
	 	
	if [ "$(isset 'apache2')" = "OFF" ]
	then
		whiptail --title  " $D_ATTENTION " --msgbox  "$D_SITEINFONOAPACHE" 10 60
		menu
	fi

	for site in "${sites[@]}" 
	do
		site=$(echo -e "$site" | grep -oP "[^/]+") 
		if [ -e "/etc/apache2/sites-available/$site.conf" ]; then
			if [ -f "/etc/apache2/sites-enabled/$site.conf" ]; then
				cheksites+=( "$site" "  âŠ³ $D_SITEACTIVE")
			else
				cheksites+=( "$site" "  â—» $D_SITENOACTIVE")
			fi
		fi
	done

	OPTIONSCTRL=$(whiptail --title  "$D_NAMESOFT" \
	--ok-button  " ÐžÐš [Enter] " --cancel-button  " $D_BACK [ESC] " \
	--menu  "\n$D_SITEMANAGEMENT\n" 20 60 10 \
	"${cheksites[@]}" 3>&1 1>&2 2>&3)
 	
	exitstatus=$?
	
	if [ $exitstatus = 0 ]  
	then
		if [ "$OPTIONSCTRL" =  "+ $D_SITEADDNEW" ]; then
			siteadd
		else 
			if [ "$OPTIONSCTRL" =  "" ]; then
				sitescontrol
			fi
			siteactions "$OPTIONSCTRL"
		fi
	else
     	menu
	fi
}

siteactions ()
{
	clear
	if [ -e "/etc/apache2/sites-available/$1.conf" ]; then
		if [ -f "/etc/apache2/sites-enabled/$1.conf" ]; then
			action=( " â—»" "$D_SITEOFF" )
		else
			action=( " âŠ³" "$D_SITEON" )
		fi
	fi

	OPTIONSITE=$(whiptail --title  "$D_NAMESOFT" \
	--ok-button  " ÐžÐš [Enter] " --cancel-button  " $D_BACK [ESC] " \
	--menu  "\n  $D_ACTIONS: $1" 20 60 10 \
	"${action[@]}" \
	" â˜¶ " "$D_SITEOPENCONF" \
	" â™¨ " "$D_SITEOPENBROWSER" \
	" â—² " "$D_SITEOPENEXPLORER" \
	" â–¦ " "$D_SITEFILEBACKUP" \
	" â‚ª " "$D_SITEBASEBACKUP" \
	" âœ˜ " "$D_SITEALLDELITE" \
	3>&1 1>&2 2>&3)
	exitstatus=$?
	
	if [ $exitstatus = 0 ]  
	then
		case $OPTIONSITE in
			" â˜¶ ") configedit "$1.conf" ;;
			" â™¨ ") su "$urun" -c "xdg-open https://$1" ;;
			" â—² ") xtermrun "$SITEPATH" "mc $HOME/www/domains/$1" ;;
			" â–¦ ") backupmenufile "$1" ;;
			" â‚ª ") backupmenubase "$1" ;;
			" âœ˜ ") sitedelete "$1" ;;
			*) switchsiteactivity "$1" ;;
		esac
	else
     	sitescontrol
	fi
	siteactions "$1"
}

sitein()
{
	if [ -n "$1" ] ; then
		SITENAME="$1"
	else
		SITENAME=$(whiptail --title  " $D_SITETITLE " \
		--ok-button  " ÐžÐš [Enter] " --cancel-button  " $D_BACK [ESC] " \
		--inputbox "\n$D_SITEBOX" 10 60 3>&1 1>&2 2>&3)
		exitstatus=$?
		isvalid=$(echo "$SITENAME" | grep -E "^([A-Za-z]+[A-Za-z0-9-]+\.?)+([A-Za-z]{2,10})?$")
		if [ $exitstatus = 0 ] ;  then
			if [ -z "$isvalid" ];  then
				echo -e "$D_SITEERR" 
				sleep 3
				sitein
			fi
		else
			sitescontrol
		fi
	fi
	SITEPATH="$HOME/www/domains/$SITENAME" # locate site folder
}


siteadd()
{
	clear
	sitein
	ishosts
	vhconfadd
	foldercreate
	basecreate
	sslcertadd
	htaccessadd
	indexadd
	assignrights
	restartapache2
	endrun
}


sitedelete()
{
	if (whiptail --title " âœ˜  $D_SITEDEL " --yesno " $D_SITEDELYN: $1 ?" 10 60); then
		cmd="$(a2dissite "$1" > /dev/null &&  \
		rm "/etc/apache2/sites-available/$1.conf" 2> /dev/null && \
		rm -R "$HOME/www/domains/$1" 2> /dev/null && \
		sed -Ei "/^127\.0\.0\.1\s+$1\s+www\.$1/d" /etc/hosts > /dev/null && \
		systemctl restart apache2 2> /dev/null)"
		progresss "$cmd" "$D_SITEDELITE $1"
		whiptail --title  " $D_DELITED " --msgbox  "Ð¡Ð°Ð¹Ñ‚ $1 $D_REMOVEDY" 10 60
		namebase="$(echo "$1" | tr "." "_")"
		isbase="$(gosql "SHOW DATABASES LIKE '$namebase'" | grep -o "$namebase")"
		if [ -n "$isbase" ]; then
			if (whiptail --title  " $D_ATTENTION " --yesno "$D_SITEDELBASEYN $namebase ?" 10 60)  
			then
				progresss "$(gosql "DROP DATABASE $namebase")" " âœ˜  $D_SITEDELBASE $namebase... "
				whiptail --title  " $D_DELITED " --msgbox  "$namebase - $D_SITEDELBASEOK" 10 60
			fi
		fi	
		sitescontrol	
	else
		sitescontrol
	fi
}

switchsiteactivity()
{
	if [ -L "/etc/apache2/sites-enabled/$1.conf" ] 
	then
		cmd="$(a2dissite "$1" > /dev/null && \
		sed -Ei "/^127\.0\.0\.1\s+$1\s+www\.$1/d" /etc/hosts)"
		progresss "$cmd" " â—¼ $D_SITEDEACTIVATE $1..."
	else
		cmd="$(a2ensite "$1" > /dev/null && \
		echo "127.0.0.1 $1 www.$1" | tee -a /etc/hosts > /dev/null)"
		progresss "$cmd" " â–º $D_SITEACTIVATE $1..."	
	fi
	restartapache2	
	sitescontrol
}

endrun()
{
	whiptail --title  " ðŸŽ‰ $D_READY " --msgbox  "$D_SITEADD https://$SITENAME" 10 60
	sitescontrol
}
